---
title: "Physician Strategy"
author: "Tim H"
date: today
fontfamily: "BC Sans"
format: 
  html:
    theme: hsiaR_html_style.scss
    toc: true
    code-fold: true
    lightbox: 
      match: auto
      effect: fade
      desc-position: bottom
      loop: false
bibliography: 
  - references.bib
editor_options: 
  chunk_output_type: console
execute: 
  echo: true
  warning: false
  message: false
  cache: false
params:
  ggplot: yes
---

```{r setup}
#| results: false

pacman::p_load(targets, hsiaR, tidyverse, reactable, htmltools, scales, patchwork)
tar_load(c('policies', 'encounters_fp', 'vt4'))

nice_gg = function(base_size = 14) {
  ggthemes::theme_clean(base_size) +
  ggplot2::theme(legend.position = 'bottom')
}

#if (!exists("params")) params = list(ggplot = T, echarts = F)
#echarts4r::e_common(font_family = "BC Sans", theme = "Westeros")
#source("R/functions.R")
```

This table shows some data on the targets for this project.

```{r}
tar_meta() |>
  select(name, time, bytes, seconds) |>
  arrange(desc(bytes)) |>
  mutate(date = as.Date(time), minutes = round(seconds / 60, 1)) |>
  select(name, date, bytes, minutes) |>
  reactable(bordered = T)
```

Here are all the functions we are gonna use:

```{r}
cat(read_lines("R/functions.R"))
```


## Physicians in Canada

CIHI data?

## MSP

We have MSP encounter data for years: `r sort(unique(msp$fiscal))`. We have VT4 data for years:  `r sort(unique(vt4$fiscal))`

### FPs

In this section, we analyze the impact of the [Longitudinal Family Physician Payment Model (LFP)](https://www2.gov.bc.ca/gov/content/health/practitioner-professional-resources/msp/physicians/longitudinal-family-physician-lfp-payment-model). This affects family doctors (FPs) only; the FPs specs are `r filter(policies, policy=='LFP')$specs[[1]] |> paste(collapse = ", ")`. The LFP model began `r filter(policies, policy=='LFP')$start_date |> format("%B %d, %Y")`. We will use that date as the threshold, although maybe we can get better info as to who is on LFP and who isn't.


#### Data Investigation

Comments:
- We can see lots of outliers for encounters.
- Is 50 enc/month a realistic average?
- Is it possible to see ~ 3000 enc/month?

```{r}
df = encounters_fp |>
  group_by(pracnum, yearmon, is_LFP) |>
  summarise(encounters = sum(encounters))

print(summary(df$encounters))

g1 = df |>
  ggplot(aes(y=is_LFP, x=encounters, color=is_LFP)) +
  geom_boxplot() +
  nice_gg() +
  scale_colour_viridis_d() +
  scale_x_continuous(labels = label_comma())
  
g2 = df |>
  ggplot(aes(x=encounters, color=is_LFP)) +
  geom_density() +
  nice_gg() +
  scale_colour_viridis_d() +
  scale_x_continuous(labels = label_comma())

g1 + g2
```


#### Time Series Plots

The red line shows LFP implementation.

```{r}
encounters_fp |>
  group_by(yearmon, is_LFP) |>
  summarise(encounters = sum(encounters)) |>
  ggplot(aes(x=yearmon, y=encounters, color=is_LFP)) +
  geom_point() +
  geom_line() +
  nice_gg() +
  scale_colour_viridis_d() +
  scale_y_continuous(labels = label_comma()) +
  geom_vline(xintercept = as.yearmon(filter(policies, policy=='LFP')$start_date), color='red', linetype = 'dashed') +
  ggtitle("Total Encounters")
```

```{r}
encounters_fp |>
  group_by(pracnum, yearmon, is_LFP) |>
  summarise(encounters = sum(encounters)) |>
  group_by(yearmon, is_LFP) |>
  summarise(encounters = mean(encounters)) |>
  ggplot(aes(x=yearmon, y=encounters, color=is_LFP)) +
  geom_point() +
  geom_line() +
  nice_gg() +
  scale_colour_viridis_d() +
  scale_y_continuous(labels = label_comma()) +
  geom_vline(xintercept = as.yearmon(filter(policies, policy=='LFP')$start_date), color='red', linetype = 'dashed') +
  ggtitle("Average Encounters per Prac per Month")
```


```{r}
encounters_fp |> group_by(pracnum, fiscal) |> summarise(encounters = sum(encounters)) |> arrange(pracnum, fiscal)
filter(vt4, funcspec %in% policies$specs[[1]]) |> select(pracnum, fiscal, msp_encounters)  |> arrange(pracnum, fiscal)
```





### Hypothesis Tests

![](output/t_test_plot_encounters.png)

![](output/t_test_plot_all_source_pd.png)


```{r}
#| results: asis
tar_load(unpaired_tests)
walk(c('t_test', 'wilcox_test'), function(col) {
  print(h3("Unpaired test: " %,% col))
  t = unnest(unpaired_tests, cols = c(col)) |>
    mutate(across(where(is.double), ~round(., 2))) |>
    select(-ends_with("_test")) |>
    reactable(bordered = T)
  print(tagList(t))
})
```

Unpaired tests show significant differences between before and after the LFP.

```{r}
#| results: asis
tar_load(paired_tests)
walk(c('t_test', 'wilcox_test'), function(col) {
  print(h3("Paired test: " %,% col))
  t = unnest(paired_tests, cols = c(col)) |>
    mutate(across(where(is.double), ~round(., 2))) |>
    select(-ends_with("_test")) |>
    reactable(bordered = T)
  print(tagList(t))
})
```

Paired tests show significant differences between before and after the LFP.


```{r}
fp_trim
```


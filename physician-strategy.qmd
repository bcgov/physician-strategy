---
title: "Physician Strategy"
author: "Tim H"
date: today
fontfamily: "BC Sans"
format: 
  html:
    theme: hsiaR_html_style.scss
    toc: true
    lightbox: 
      match: auto
      effect: fade
      desc-position: bottom
      loop: false
bibliography: 
  - references.bib
editor_options: 
  chunk_output_type: console
execute: 
  echo: false
  warning: false
  message: false
  cache: false
params:
  ggplot: yes
---

```{r setup}
pacman::p_load(targets, hsiaR, tidyverse, reactable, htmltools)
if (!exists("params")) params = list(ggplot = T, echarts = F)
#echarts4r::e_common(font_family = "BC Sans", theme = "Westeros")
source("R/functions.R")
tar_load(c(LFP, fp_trim))
```

## Physicians in Canada

Lorem ipsum dolor sit amet consectetur adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat. In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor. Pulvinar vivamus fringilla lacus nec metus bibendum egestas. Iaculis massa nisl malesuada lacinia integer nunc posuere. Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per conubia nostra inceptos himenaeos.

Lorem ipsum dolor sit amet consectetur adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat. In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor. Pulvinar vivamus fringilla lacus nec metus bibendum egestas. Iaculis massa nisl malesuada lacinia integer nunc posuere. Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per conubia nostra inceptos himenaeos.

## MSP

This table shows some data on the HealthIdeas queries.

```{r}
tar_meta() |> 
  #filter(str_ends(name, "_raw")) |> 
  select(name, time, bytes, seconds) |>
  arrange(desc(bytes)) |>
  mutate(date = as.Date(time), minutes = round(seconds / 60, 1)) |>
  select(name, date, bytes, minutes) |>
  reactable(bordered = T)
```

Here are the fiscal years for encounters data:

As of right now, VT4 data is only up to 2023/24. This is not good, cuz LFP is recent so **FOR NOW** I'm gonna add rows that assume pracs just have the same info from the last year on record (plus one year older). See `clean_vt4`. We'll fix this in the future.

```{r}
#| eval: false
tar_load(c(msp, vt4))
sort(unique(msp$fiscal))
sort(unique(vt4$fiscal))
stopifnot(identical(max(vt4$fiscal), max(msp$fiscal)))
```

### FPs

In this section, we analyze the impact of the [Longitudinal Family Physician Payment Model (LFP)](https://www2.gov.bc.ca/gov/content/health/practitioner-professional-resources/msp/physicians/longitudinal-family-physician-lfp-payment-model). This affects family doctors (FPs) only; the FPs specs are `r first(LFP$specs) |> paste(collapse = ", ")`. The LFP model began February 1, 2023. We will use that date as the threshold, although maybe we can get better info as to who is on LFP and who isn't.


#### Data Investigation

There is something suspicious about earnings.

![](output/density_pd.png)


![](output/box_pd.png)

Now let's look at encounters.

![](output/density_enc.png)

![](output/box_enc.png)

#### Time Series Plots

The red line shows LFP implementation.

![](output/ts_enc_plot.png)

![](output/ts_pracs_plot.png)

![](output/ts_enc_per_prac_plot.png)
![](output/ts_pd_plot.png)

![](output/ts_pd_per_prac_plot.png)



This table shows us how many days we have data, before and after the implementation of LFP. We will balance the data so that each side is equal.



### Hypothesis Tests

![](output/t_test_plot_encounters.png)

![](output/t_test_plot_all_source_pd.png)


```{r}
#| results: asis
tar_load(unpaired_tests)
walk(c('t_test', 'wilcox_test'), function(col) {
  print(h3("Unpaired test: " %,% col))
  t = unnest(unpaired_tests, cols = c(col)) |>
    mutate(across(where(is.double), ~round(., 2))) |>
    select(-ends_with("_test")) |>
    reactable(bordered = T)
  print(tagList(t))
})
```

Unpaired tests show significant differences between before and after the LFP.

```{r}
#| results: asis
tar_load(paired_tests)
walk(c('t_test', 'wilcox_test'), function(col) {
  print(h3("Paired test: " %,% col))
  t = unnest(paired_tests, cols = c(col)) |>
    mutate(across(where(is.double), ~round(., 2))) |>
    select(-ends_with("_test")) |>
    reactable(bordered = T)
  print(tagList(t))
})
```

Paired tests show significant differences between before and after the LFP.


```{r}
fp_trim
```


---
title: "Physician Strategy"
author: "Tim H"
date: today
fontfamily: "BC Sans"
format: 
  html:
    theme: hsiaR_html_style.scss
    toc: true
    lightbox: 
      match: auto
      effect: fade
      desc-position: bottom
      loop: false
bibliography: 
  - references.bib
editor_options: 
  chunk_output_type: console
execute: 
  echo: false
  warning: false
  message: false
  cache: false
params:
  ggplot: yes
---

```{r setup}
pacman::p_load(hsiaR, tidyverse, reactable)
if (!exists("params")) params = list(ggplot = T, echarts = F)
#echarts4r::e_common(font_family = "BC Sans", theme = "Westeros")
source("R/functions.R")

tar_load(c(policy_dates, fp, LFP, fp_per_prac))
```

## Physicians in Canada

Lorem ipsum dolor sit amet consectetur adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat. In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor. Pulvinar vivamus fringilla lacus nec metus bibendum egestas. Iaculis massa nisl malesuada lacinia integer nunc posuere. Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per conubia nostra inceptos himenaeos.

Lorem ipsum dolor sit amet consectetur adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat. In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor. Pulvinar vivamus fringilla lacus nec metus bibendum egestas. Iaculis massa nisl malesuada lacinia integer nunc posuere. Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per conubia nostra inceptos himenaeos.

## MSP

This table shows some data on the HealthIdeas queries.

```{r}
tar_meta() |> 
  #filter(str_ends(name, "_raw")) |> 
  select(name, time, bytes, seconds) |>
  arrange(desc(bytes)) |>
  mutate(date = as.Date(time), minutes = round(seconds / 60, 1)) |>
  select(name, date, bytes, minutes) |>
  reactable()
```

Here are the fiscal years for encounters data:

As of right now, VT4 data is only up to 2023/24. This is not good, cuz LFP is recent so **FOR NOW** I'm gonna add rows that assume pracs just have the same info from the last year on record (plus one year older). See `clean_vt4`. We'll fix this in the future.

```{r}
#| eval: false
tar_load(c(msp, vt4))
sort(unique(msp$fiscal))
sort(unique(vt4$fiscal))
stopifnot(identical(max(vt4$fiscal), max(msp$fiscal)))
```

### FPs

In this section, we analyze the impact of the [Longitudinal Family Physician Payment Model (LFP)](https://www2.gov.bc.ca/gov/content/health/practitioner-professional-resources/msp/physicians/longitudinal-family-physician-lfp-payment-model). This affects family doctors (FPs) only; the FPs specs are `r first(LFP$specs) |> paste(collapse = ", ")`. The LFP model began February 1, 2023. We will use that date as the threshold, although maybe we can get better info as to who is on LFP and who isn't.


#### Data Investigation

```{r}
#| eval: false

# ensure one row per day per phys
stopifnot(
  fp |>
    count(pracnum, servdt) |>
    pull(n) |>
    unique() == 1
)

```


```{r}
fp_per_prac
```

There is something suspicious about earnings.

![](output/density_pd.png)


![](output/box_pd.png)

```{r}
# The median is over $4M? Per month?
summary(fp_per_prac$all_source_pd)
```

Now let's look at encounters.

![](output/density_enc.png)

![](output/box_enc.png)

#### Time Series Plots

The red line shows LFP implementation.

![](output/ts_enc_plot.png)

![](output/ts_pracs_plot.png)

![](output/ts_enc_per_prac_plot.png)
![](output/ts_pd_plot.png)

![](output/ts_pd_per_prac_plot.png)



This table shows us how many days we have data, before and after the implementation of LFP. We will balance the data so that each side is equal.





<!-- ```{r} -->
<!-- n_days = fp |> -->
<!--   group_by(is_treated) |> -->
<!--   summarise(n_days = n_distinct(servdt)) -->

<!-- plus_minus = n_days[[2,2]] -->

<!-- n_days -->
<!-- ``` -->

<!-- ```{r} -->

<!-- # check they're equal -->
<!-- stopifnot( -->
<!--   fp_trim |> -->
<!--     group_by(is_treated) |> -->
<!--     summarise(n_days = n_distinct(servdt)) |> -->
<!--     pull(n_days) |> -->
<!--     unique() |> -->
<!--     length() == 1 -->
<!-- ) -->
<!-- ``` -->


<!-- ### Hypothesis Tests -->

<!-- ```{r} -->
<!-- fp_pop = fp_trim |> -->
<!--   group_by(servdt) |> -->
<!--   summarise(pop = n_distinct(pracnum)) |> -->
<!--   ungroup() -->

<!-- fp_pop -->
<!-- ``` -->

<!-- ```{r} -->
<!-- unpaired_tests = create_unpaired_tests(fp_trim) -->
<!-- unnest(unpaired_tests, cols = c(t_test, wilcox_test), names_repair = 'minimal') -->
<!-- ``` -->


<!-- ```{r} -->
<!-- group_vars = c('encounters', 'all_source_pd') -->
<!-- fp_trim |> -->
<!--     select(pracnum, is_treated, !!!group_vars) |> -->
<!--     group_by(pracnum, is_treated) |> -->
<!--     summarise(across(c(!!!group_vars), sum)) |> -->
<!--     ungroup() |> -->
<!--   ggplot(aes(x=is_treated, y=encounters, group=pracnum)) + -->
<!--   geom_line() -->

<!-- |> -->
<!--     pivot_wider(names_from = is_treated, values_from = c(!!!group_vars)) |> -->
<!--     na.omit() -->
<!-- ``` -->



<!-- ```{r} -->
<!-- enc_per_day = fp_trim |> -->
<!--   group_by(is_treated, pracnum) |> -->
<!--   summarise(encounters = mean(encounters)) |> -->
<!--   ungroup() |> -->
<!--   na.omit() -->
<!-- ``` -->

<!-- ```{r} -->
<!-- enc_per_day |> -->
<!--   pivot_wider(names_from = is_treated, values_from = encounters, ) |> -->
<!--   na.omit() |> -->
<!--   ggplot(aes(x=`FALSE`, y=`TRUE`)) + -->
<!--   geom_point(alpha = .3, color = viridis::viridis_pal()(1)) + -->
<!--   #geom_smooth(method = 'lm', linetype = 'dotted', se=F) + -->
<!--   scale_x_continuous(limits = c(0,100), expand = expansion(mult = c(0, 0), add = c(0,1)))  -->
<!--   scale_y_continuous(limits = c(0,100), expand = expansion(mult = c(0, 0), add = c(0,1))) + -->
<!--   #theme_minimal() + -->
<!--   ggthemes::theme_clean() + -->
<!--   geom_abline(slope = .5) + -->
<!--   ggtitle("Encounters Per Day, Before and After LFP", "Most FPs see more patients after LFP") + -->
<!--   labs(x="Before LFP", y="After LPF") -->
<!-- ``` -->




<!-- ```{r} -->
<!-- enc_per_day |> -->
<!--   ggplot(aes(x=is_treated, y=encounters, color=is_treated)) + -->
<!--   geom_jitter(alpha=.5) + -->
<!--   stat_summary(fun = mean, geom = 'point', aes(group=1), color='red') + -->
<!--   stat_summary(fun = mean, geom = 'line', aes(group=1), color='red') + -->
<!--   ggthemes::theme_clean() + -->
<!--   scale_color_viridis_d() + -->
<!--   ggtitle("Average Encounters per day") -->
<!-- ``` -->

<!-- ```{r} -->
<!-- enc_per_day |> -->
<!--   ggplot(aes(x=is_treated, y=encounters, color=is_treated)) + -->
<!--   geom_boxplot(alpha=.5, outlier.shape = 2) + -->
<!--   ggthemes::theme_clean() + -->
<!--   scale_color_viridis_d() + -->
<!--   ggtitle("Average Encounters per day", "Distributions are kind of the same save some outliers") + -->
<!--   theme(legend.position = 'none') -->
<!-- ``` -->


<!-- ```{r} -->
<!-- enc_per_day |> -->
<!--   ggplot(aes(x=encounters, color=is_treated)) + -->
<!--   geom_density() + -->
<!--   ggthemes::theme_clean() + -->
<!--   ggtitle("Sure ain't normally distributed") -->
<!-- ``` -->

<!-- ```{r} -->
<!-- t.test(encounters ~ is_treated, data = enc_per_day) # rejected! -->
<!-- ``` -->

<!-- ```{r} -->
<!-- cihi |> -->
<!--   filter(jurisdiction == "B.C.", health_region == 'B.C.', specialty == 'Family medicine') |> -->
<!--   select(year, number_of_physicians_who_returned_from_abroad) |> -->
<!--   mutate(is_treated = year > year(LFP$start_date)) |> -->
<!--   mutate(size = is_treated * 3) |> -->
<!--   ggplot(aes(x=year, y=number_of_physicians_who_returned_from_abroad)) + -->
<!--   geom_line(aes(color=is_treated)) + -->
<!--   geom_point(aes(color=is_treated, size=size)) + -->
<!--   geom_smooth(method = 'lm', se=F, color='black', linetype='dashed', linewidth=.5) + -->
<!--   ggthemes::theme_clean() + -->
<!--   scale_colour_viridis_d() -->
<!-- ``` -->


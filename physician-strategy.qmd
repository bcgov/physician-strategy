---
title: "Physician Strategy"
author: "Tim H"
date: today
fontfamily: "BC Sans"
number-sections: true
format: 
  html:
    theme: style/hsiaR_style.scss
    toc: true
    code-fold: true
    fig-width: 10
    lightbox: 
      match: auto
      effect: fade
      desc-position: bottom
      loop: false
bibliography: 
  - references.bib
editor_options: 
  chunk_output_type: console
execute: 
  echo: true
  warning: false
  message: false
  cache: false
  results: asis
---

# Introduction

```{r setup}
#| results: false

pacman::p_load(targets, hsiaR, tidyverse, reactable, htmltools, scales)

tar_load(c('policies', 'msp_fp_encounters', 'msp_fp_fitms', 'cihi', 'vt4', 'vt4_switches'))

source("R/functions.R")

nice_gg = function(base_size = 16) {
  ggthemes::theme_clean(base_size) +
  ggplot2::theme(legend.position = 'bottom')
}
```

This table shows some data on the "raw" targets for this project.

```{r}
#| collapse: true
tar_meta() |>
  select(name, time, bytes, seconds) |>
  filter(str_ends(name, "_raw")) |>
  arrange(desc(bytes)) |>
  mutate(date = as.Date(time), minutes = round(seconds / 60, 1)) |>
  select(name, date, bytes, minutes) |>
  reactable(bordered = T)
```


Here are all the "pull" functions we are gonna use:

```{r}
#| collapse: true
#| 
print(pull_msp_encounters)
print(pull_msp_fitms)
```


# FPs

In this section, we analyze the impact of the [Longitudinal Family Physician Payment Model (LFP)](https://www2.gov.bc.ca/gov/content/health/practitioner-professional-resources/msp/physicians/longitudinal-family-physician-lfp-payment-model). This affects family doctors (FPs) only; the FPs specs are `r filter(policies, policy=='LFP')$specs[[1]] |> paste(collapse = ", ")`. The LFP model began `r filter(policies, policy=='LFP')$start_date |> format("%B %d, %Y")`. We will use that date as the threshold, although maybe we can get better info as to who is on LFP and who isn't.

The date range for our data is from `r min(msp_fp_encounters$srv_mth)` to `r max(msp_fp_encounters$srv_mth)`. Note that we attempt to gather roughly equal-sized dates before and after LFP, truncating data from the most recent 3 months, and only considering entire months. Also, I have set a minimum start date for September 1, 2020 due to Covid.

## Data

Here, we show summary statistics for encounters and demonstrate the large right skew.

```{r}
msp_fp_encounters |>
  group_by(is_LFP, srv_mth) |>
  summarise(mean = round(mean(encounters)), sum = sum(encounters)) |>
  mutate(across(where(is.numeric), label_comma())) |>
  reactable(bordered = T)
```


```{r}
msp_fp_encounters |>
  group_by(pracnum, srv_mth, is_LFP) |>
  summarise(encounters = sum(encounters)) |>
  ggplot(aes(y=is_LFP, x=encounters, color=is_LFP)) +
  geom_boxplot() +
  nice_gg() +
  scale_colour_viridis_d() +
  scale_x_continuous(labels = label_comma()) +
  theme(legend.position = 'none') +
  ggtitle("Boxplot of total encounters per FP")
```

```{r}
msp_fp_encounters |>
  group_by(pracnum, srv_mth, is_LFP) |>
  summarise(encounters = sum(encounters)) |>
  ggplot(aes(x=encounters, color=is_LFP)) +
  geom_density() +
  nice_gg() +
  scale_colour_viridis_d() +
  scale_x_continuous(labels = label_comma()) +
  theme(legend.position = 'bottom') +
  ggtitle("Density plot of total encounters per FP")
```

## Time Series Plots

In the following graphs, the vertical red line shows LFP implementation.

```{r}
msp_fp_encounters |>
  group_by(srv_mth, is_LFP) |>
  summarise(encounters = sum(encounters)) |>
  ggplot(aes(x=srv_mth, y=encounters, color=is_LFP)) +
  geom_point() +
  geom_line() +
  geom_smooth(method = 'lm', se = F) +
  nice_gg() +
  scale_colour_viridis_d() +
  scale_y_continuous(labels = label_comma()) +
  geom_vline(xintercept = zoo::as.yearmon(filter(policies, policy=='LFP')$start_date), color='red', linetype = 'dashed') +
  theme(legend.position = 'none') +
  labs(x=NULL, y=NULL) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  ggtitle("Total Encounters")
```

```{r}
msp_fp_encounters |>
  group_by(pracnum, srv_mth, is_LFP) |>
  summarise(encounters = sum(encounters)) |>
  group_by(srv_mth, is_LFP) |>
  summarise(encounters = mean(encounters)) |>
  ggplot(aes(x=srv_mth, y=encounters, color=is_LFP)) +
  geom_point() +
  geom_line() +
  geom_smooth(method = 'lm', se = F) +
  nice_gg() +
  scale_colour_viridis_d() +
  scale_y_continuous(labels = label_comma()) +
  geom_vline(xintercept = zoo::as.yearmon(filter(policies, policy=='LFP')$start_date), color='red', linetype = 'dashed') +
  theme(legend.position = 'none') +
  labs(x=NULL, y=NULL) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  ggtitle("Average Encounters per Prac per Month")
```

```{r}
msp_fp_encounters |>
  group_by(srv_mth, is_LFP) |>
  summarise(n_pracs = n_distinct(pracnum), .groups = 'drop') |>
  ggplot(aes(x=srv_mth, y=n_pracs, color=is_LFP)) +
  geom_point() +
  geom_line() +
  geom_smooth(method = 'lm', se = F) +
  nice_gg() +
  scale_colour_viridis_d() +
  scale_y_continuous(labels = label_comma()) +
  geom_vline(xintercept = zoo::as.yearmon(filter(policies, policy=='LFP')$start_date), color='red', linetype = 'dashed') +
  theme(legend.position = 'none') +
  labs(x=NULL, y=NULL) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  ggtitle("Distinct Practitioners per Month")
```

```{r}
msp_fp_fitms |>
  group_by(srv_mth, is_LFP) |>
  summarise(expdamt = sum(expdamt)) |>
  ggplot(aes(x=srv_mth, y=expdamt, color=is_LFP)) +
  geom_point() +
  geom_line() +
  geom_smooth(method = 'lm', se = F) +
  nice_gg() +
  scale_colour_viridis_d() +
  scale_y_continuous(labels = label_currency()) +
  geom_vline(xintercept = zoo::as.yearmon(filter(policies, policy=='LFP')$start_date), color='red', linetype = 'dashed') +
  theme(legend.position = 'none') +
  labs(x=NULL, y=NULL) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  ggtitle("expdamt")
```

```{r}
inner_join(
  msp_fp_encounters |>
    group_by(srv_mth, is_LFP) |>
    summarise(encounters = sum(encounters))
  ,
  msp_fp_fitms |>
    group_by(srv_mth, is_LFP) |>
    summarise(expdamt = sum(expdamt))
) |>
  mutate(expdamt_per_enc = expdamt / encounters) |>
  ggplot(aes(x=srv_mth, y=expdamt_per_enc, color=is_LFP)) +
  geom_point() +
  geom_line() +
  geom_smooth(method = 'lm', se = F) +
  nice_gg() +
  scale_colour_viridis_d() +
  scale_y_continuous(labels = label_currency()) +
  geom_vline(xintercept = zoo::as.yearmon(filter(policies, policy=='LFP')$start_date), color='red', linetype = 'dashed') +
  theme(legend.position = 'none') +
  labs(x=NULL, y=NULL) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  ggtitle("expdamt per encounter")
```


```{r}
cihi |>
  filter(specialty == "Family medicine") |>
  select(-specialty, -number_of_physicians) |>
  mutate(is_LFP = between(year, year(policies$start_date), ifelse(is.infinite(policies$end_date), Inf, year(policies$end_date))), .after=1) |>
  set_names(c("year", "is_LFP", "returned from abroad", "moved abroad", "net migration")) |>
  pivot_longer(cols = 3:5) |>
  ggplot(aes(x=year, y=value, color=name)) +
  geom_line() +
  geom_point() +
  nice_gg() +
  scale_colour_viridis_d() +
  scale_y_continuous(labels = label_comma()) +
  geom_vline(xintercept = zoo::as.yearmon(filter(policies, policy=='LFP')$start_date), color='red', linetype = 'dashed') +
  theme(legend.position = 'bottom') +
  labs(x="year", y="# FPs", color=NULL) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  ggtitle("B.C. FP Migration Patterns", "Source = CIHI")
```

This one doesn't seem to matter. Was trying to suss out hospitalists.

```{r}
fp_regex = "(?i)family|general practice"

cihi |>
  filter(str_detect(specialty, fp_regex)) |>
  filter(str_starts(specialty, "_")) |>
  mutate(specialty = str_remove_all(specialty, "_")) |>
  ggplot(aes(x=year, y=number_of_physicians, color=specialty)) +
  geom_line() +
  geom_point() +
  nice_gg() +
    scale_colour_viridis_d() +
  scale_y_continuous(labels = label_comma()) +
  geom_vline(xintercept = zoo::as.yearmon(filter(policies, policy=='LFP')$start_date), color='red', linetype = 'dashed') +
  theme(legend.position = 'bottom') +
  labs(x="year", y="# FPs", color=NULL) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  ggtitle("B.C. FP Migration Patterns", "Source = CIHI")
```

```{r}
cihi |>
  select(year, specialty, number_of_physicians) |>
  filter(specialty %in% c("All physicians", "Family medicine")) |>
  pivot_wider(names_from = specialty, values_from = number_of_physicians) |>
  mutate(perc_fp = `Family medicine` / `All physicians`) |>
  select(year, perc_fp) |>
  ggplot(aes(x=year, y=perc_fp)) +
  geom_line() +
  geom_point() +
  nice_gg() +
  scale_colour_viridis_d() +
  scale_y_continuous(labels = label_percent()) +
  geom_vline(xintercept = zoo::as.yearmon(filter(policies, policy=='LFP')$start_date), color='red', linetype = 'dashed') +
  theme(legend.position = 'bottom') +
  labs(x="year", y=NULL, color=NULL) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  ggtitle("Percent of total physicians that are FP", "Source = CIHI")
```

```{r}
vt4 |>
  count(fiscal) |>
  ggplot(aes(x=fiscal, y=n, group=1)) +
  geom_line() +
  geom_point() +
  nice_gg() +
  scale_colour_viridis_d() +
  scale_y_continuous(labels = label_comma()) +
  geom_vline(xintercept = filter(policies, policy=='LFP')$start_date |> as_fiscal(example_format = "2020/2021"), color='red', linetype = 'dashed') +
  theme(legend.position = 'bottom') +
  labs(x=NULL, y=NULL) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  ggtitle("Headcount of all physicians", "Source = VT4")
```

```{r}
vt4 |>
  mutate(is_fp = funcspec %in% (policies |> filter(policy == "LFP") |> pull(specs) |> first())) |>
  count(fiscal, is_fp) |>
  ggplot(aes(x=fiscal, y=n, color=is_fp, group=is_fp)) +
  geom_line() +
  geom_point() +
  nice_gg() +
  scale_colour_viridis_d() +
  scale_y_continuous(labels = label_comma()) +
  geom_vline(xintercept = filter(policies, policy=='LFP')$start_date |> as_fiscal(example_format = "2020/2021"), color='red', linetype = 'dashed') +
  theme(legend.position = 'bottom') +
  labs(x=NULL, y=NULL) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  ggtitle("Headcount of FPs and non-FPs", "Source = VT4")
```

```{r}
vt4_switches |>
  na.omit() |>
  filter(change != "no_change") |>
  count(fiscal, is_LFP, change) |>
  mutate(change = case_match(change,  "fp_switch" ~ "switch within FP", "new_fp" ~ "switch to FP", "new_non_fp" ~ "switch from FP")) |>
  mutate(year = as.integer(substr(fiscal, 1, 4))) |>
  ggplot(aes(x=year, y=n, color=change)) +
  geom_line() +
  geom_point() +
  nice_gg() +
  scale_colour_viridis_d() +
  scale_x_continuous(labels = function(x) paste0(x, "/", x + 1)) +
  scale_y_continuous(labels = label_comma()) +
  geom_vline(xintercept = zoo::as.yearmon(filter(policies, policy=='LFP')$start_date), color='red', linetype = 'dashed') +
  theme(legend.position = 'bottom') +
  labs(x="year", y=NULL, color=NULL) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  ggtitle("Switching to and from FP", "Source = VT4")
```



The evidence suggests a behavioural change from LFP implementation. Since LFP, there are fewer FPs, and they are having fewer encounters. There is not enough data to establish whether LFP has affected FP migration patterns.


## Hypothesis Tests

### Unpaired mean tests

Here, we test whether the mean of a variable is statistically different before and after the implementation of LFP. These are unpaired tests, so they just test group means and do not account for individual changes. The t-test assumes the variable follows a normal distribution, which does not hold; hence, we include a non-parametric Wilcox test. We will consider three variables: total number of encounters, total count of practitioners, and average number of encounters per practitioner.

```{r}
vars = c("encounters", "pracs", "encounters_per_prac")

df = msp_fp_encounters |>
  group_by(srv_mth, is_LFP) |>
  summarise(
    encounters = sum(encounters),
    pracs = n_distinct(pracnum),
    encounters_per_prac = encounters / pracs
  , .groups = 'drop')

t_unpaired = map(vars, function(var) {
  t = t.test(reformulate("is_LFP", response = var), data = df) |> 
    broom::tidy() |>
    mutate(variable = var, .before = 1) |>
    mutate(is_significant = p.value < .05, .after=1)
}) |>
  bind_rows() |>
  select(variable, is_significant, p.value, statistic, conf.low, conf.high) |>
  mutate(across(where(is.double), ~round(., 2)))

w_unpaired = map(vars, function(var) {
  t = wilcox.test(reformulate("is_LFP", response = var), data = df) |> 
    broom::tidy() |>
    mutate(variable = var, .before = 1) |>
    mutate(is_significant = p.value < .05, .after=1)
}) |>
  bind_rows() |>
  select(variable, is_significant, p.value, statistic) |>
  mutate(across(where(is.double), ~round(., 2)))

```

### T test
`r reactable(t_unpaired, bordered=T)`

### Wilcox test
`r reactable(w_unpaired, bordered=T)`

We can conclude that in general there are significant differences before and after LFP.

### Paired mean tests

In this section, we run paired mean tests. These are specific to individual doctors---we are asking whether individual doctors' mean number of encounters changes following LFP implementation. As before, we consider non-parametric tests, since the data are not Gaussian. 

```{r}
df1 = msp_fp_encounters |>
  group_by(pracnum, is_LFP) |>
  summarise(encounters = sum(encounters), .groups = 'drop') |>
  pivot_wider(names_from = is_LFP, values_from=encounters)

df2 = msp_fp_encounters |>
  group_by(pracnum, srv_mth, is_LFP) |>
  summarise(encounters = sum(encounters), .groups = 'drop') |>
  pivot_wider(names_from = is_LFP, values_from=encounters)

t_paired = t.test(df1$`FALSE`, df1$`TRUE`, paired = T) |> 
  broom::tidy() |>
  mutate(is_significant = p.value < .05, .before=1) |>
  select(is_significant, p.value, statistic, conf.low, conf.high) |>
  mutate(across(where(is.double), ~round(., 2)))

w_paired = wilcox.test(df1$`FALSE`, df1$`TRUE`, paired = T) |> 
  broom::tidy() |>
  mutate(is_significant = p.value < .05, .after=1) |>
  select(is_significant, p.value, statistic) |>
  mutate(across(where(is.double), ~round(., 2)))
```

### T test
`r reactable(t_paired, bordered=T)`

### Wilcox test
`r reactable(w_paired, bordered=T)`



---
title: "Physician Strategy"
author: "Tim H"
date: today
server: shiny
fontfamily: "BC Sans"
format: 
  html:
    theme: hsiaR_html_style.scss
    toc: true
    lightbox: 
      match: auto
      effect: fade
      desc-position: bottom
      loop: false
bibliography: 
  - references.bib
editor_options: 
  chunk_output_type: console
execute: 
  echo: fenced
  warning: false
  message: false
params:
  ggplot: yes
  echarts: yes
  shiny: no
  plus_minus: !expr 365*2
---

```{r setup}
pacman::p_load(targets, tarchetypes, hsiaR, tidyverse)
# invisible(extrafont::choose_font("BC Sans", quiet = T))
# extrafont::loadfonts()

if (!exists("params")) params = list(ggplot = T, echarts = F, shiny = F)

#ggplot2::theme_set(ggthemes::theme_clean(base_family = "BC Sans"))
ggplot2::theme_set(ggthemes::theme_clean())
echarts4r::e_common(font_family = "BC Sans", theme = "Westeros")

print_graphs = function(n) paste0(if (params$ggplot) "g" else "e", n) |> tar_read_raw()

source("R/functions.R")
```

## Physicians in Canada

Lorem ipsum dolor sit amet consectetur adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat. In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor. Pulvinar vivamus fringilla lacus nec metus bibendum egestas. Iaculis massa nisl malesuada lacinia integer nunc posuere. Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per conubia nostra inceptos himenaeos.

Lorem ipsum dolor sit amet consectetur adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat. In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor. Pulvinar vivamus fringilla lacus nec metus bibendum egestas. Iaculis massa nisl malesuada lacinia integer nunc posuere. Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per conubia nostra inceptos himenaeos.

```{r}
#| context: data
tar_load(c(g_1, e_1, ui_1))
```

```{r}
#| eval: !expr params$ggplot
g_1
```

```{r}
#| eval: !expr params$echarts
e_1
```

```{r}
#| eval: !expr params$shiny
#| column: page
ui_1
```

```{r}
#| eval: false
#| context: server

output$p1 = renderPlot(g_1_fn(filter(cihi_data_1, health_region %in% input$prov)))
```

Lorem ipsum dolor sit amet consectetur adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat. In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor. Pulvinar vivamus fringilla lacus nec metus bibendum egestas. Iaculis massa nisl malesuada lacinia integer nunc posuere. Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per conubia nostra inceptos himenaeos.

Lorem ipsum dolor sit amet consectetur adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat. In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor. Pulvinar vivamus fringilla lacus nec metus bibendum egestas. Iaculis massa nisl malesuada lacinia integer nunc posuere. Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per conubia nostra inceptos himenaeos.

Lorem ipsum dolor sit amet consectetur adipiscing elit. Quisque faucibus ex sapien vitae pellentesque sem placerat. In id cursus mi pretium tellus duis convallis. Tempus leo eu aenean sed diam urna tempor. Pulvinar vivamus fringilla lacus nec metus bibendum egestas. Iaculis massa nisl malesuada lacinia integer nunc posuere. Ut hendrerit semper vel class aptent taciti sociosqu. Ad litora torquent per conubia nostra inceptos himenaeos.

## Physicians Comparison


## Physician Age


## Gender


## Specialty

## Encounters

Encounters data extracted `r fs::file_info("_targets/objects/encounters_raw")$modification_time |> format("%B %d, %Y")`.

VT4 data extracted `r fs::file_info("_targets/objects/vt4_raw")$modification_time |> format("%B %d, %Y")`.

### FPs

```{r}
tar_load(c(policy_dates, encounters_fps))
LFP = policy_dates |> filter(anything_else == 'Family medicine')
encounters_LFP = encounters_fps |> 
  filter(between(servdt, policy_dates$start_date - params$plus_minus, policy_dates$start_date + params$plus_minus))
```

```{r}
n_days = encounters_fps |>
  group_by(is_treated) |>
  summarise(n_days = n_distinct(servdt))

# 425 'treated' days, 4689 'untreated'

plus_minus = n_days[[2,2]]

encounters_pm = encounters_fps |> 
  filter(between(servdt, policy_dates$start_date - plus_minus, policy_dates$start_date + plus_minus))
```


```{r}
#| eval: false

# quick sanity check
encounters_pm |>
  group_by(yearmon) |>
  summarise(msp_encounters = sum(msp_encounters)) |>
  ungroup() |>
  ggplot(aes(x=yearmon, y=msp_encounters)) +
  geom_line() +
  geom_vline(xintercept = as.yearmon(LFP$start_date), color='red', linetype = 'dashed') +
  ggthemes::theme_clean() +
  scale_color_viridis_d()
```


```{r}
# mean encounters per day

encounters_LFP |>
  group_by(is_treated) |>
  summarise(msp_encounters = mean(msp_encounters))
```

```{r}
plot_LFP_encounters(encounters_LFP, value = "msp_encounters", .f = sum) +
  ggtitle("Total MSP Encounters by Month") +
  scale_y_continuous(labels = scales::label_comma())
```

```{r}
plot_LFP_encounters(encounters_LFP, value = "msp_encounters", .f = mean) +
  ggtitle("Mean MSP Encounters by Month") +
  scale_y_continuous(labels = scales::label_comma()) +
  labs(y='mean # msp encounters per prac')
```

```{r}
plot_LFP_encounters(encounters_LFP, value = "pracnum", .f = n_distinct) +
  ggtitle("# distinct FP pracs per month") +
  scale_y_continuous(labels = scales::label_comma())
```

```{r}
encounters_LFP |>
  group_by(yearmon, is_treated, pracnum) |>
  summarise(all_source_pd = sum(all_source_pd) / 10^6) |>
  plot_LFP_encounters(group_vars = c("yearmon", "is_treated"), value = "all_source_pd", .f = mean) +
  ggtitle("Average All Source PD per prac") +
  scale_y_continuous(labels = scales::label_dollar(accuracy = .1, suffix = "M"))
```

```{r}
encounters_LFP |>
  group_by(yearmon, is_treated) |>
  summarise(all_source_pd = sum(all_source_pd), msp_encounters = sum(msp_encounters)) |>
  ungroup() |>
  mutate(pd_per_enc = all_source_pd / msp_encounters) |>
  plot_LFP_encounters(group_vars = c("yearmon", "is_treated"), value = "pd_per_enc", .f = sum) +
  ggtitle("Sum All Source PD per encounter", "LFP increased all source pd by XXX") +
  scale_y_continuous(labels = scales::label_dollar(accuracy = 1))
```

### T Tests

```{r}
enc_per_day = encounters_pm |>
  filter(between(servdt, policy_dates$start_date - 365/2, policy_dates$start_date + 365/2)) |>
  group_by(is_treated, pracnum) |>
  summarise(msp_encounters = mean(msp_encounters)) |>
  ungroup()
```

```{r}
enc_per_day |>
  ggplot(aes(x=is_treated, y=msp_encounters, color=is_treated)) +
  geom_jitter(alpha=.5) +
  stat_summary(fun = mean, geom = 'point', aes(group=1), color='red') +
  stat_summary(fun = mean, geom = 'line', aes(group=1), color='red') +
  ggthemes::theme_clean() +
  scale_color_viridis_d() +
  ggtitle("Average Encounters per day")
```


```{r}
enc_per_day |>
  ggplot(aes(x=msp_encounters, color=is_treated)) +
  geom_density() +
  ggthemes::theme_clean() +
  ggtitle("Sure ain't normally distributed")
```

```{r}
t.test(msp_encounters ~ is_treated, data = enc_per_day) # rejected!
```


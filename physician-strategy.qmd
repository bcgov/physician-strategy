---
title: "Physician Strategy"
author: "Tim H"
date: today
format: 
  html:
    theme: style/hsiaR_html_style.scss
    fig-width: 8
    fig-height: 5.5
    fig-align: center
    fig-dpi: 150
    dev: svg  
    lightbox: 
      match: auto
      effect: fade
      desc-position: bottom
      loop: false
    # include-after-body: _fullscreen-button.html
bibliography: 
  - references.bib
editor_options: 
  chunk_output_type: console
execute: 
  echo: false
  warning: false
  message: false
params:
  use_rds: yes
---

```{r setup}
# install packages
pacman::p_load(tidyverse, hsiaR, patchwork, ggiraph)

# ggplot theme
ggplot2::theme_set(
  ggthemes::theme_clean(base_size = 14, base_family = "BC Sans") +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10, unit = "pt"),
    
  )
)
```

```{r}
# con = hiConnect()
```

```{r}
if (!fs::file_exists("data/cihi.rds") || !params$use_rds) {

  cihi = readxl::read_excel(Sys.getenv("CIHI_PATH"), sheet="Table 1", range = "A3:BH84800") |>
    rename_with(tolower) |>
    rename_with(~str_remove_all(., "\\r|\\n|:")) |>
    rename_with(~str_replace_all(., "/", " ")) |> 
    rename_with(~str_replace_all(., " ", "_")) |> 
    rename_with(~str_replace_all(., fixed("\u2013"), "-")) |> # replace en-dashes -- yes, it matters
    rename(phys_pop_ratio = 'physician-to-100,000_population_ratio') |>
    mutate(across(c("year", "specialty_sort", "statistics_canada_population", "net_migration_between_canadian_jurisdictions", starts_with(c("number", "age_group", "place_of", "university_of", "years_since"))), as.integer)) |>
    mutate(across(c("phys_pop_ratio", starts_with(c("average", "median"))), as.double)) |> 
    mutate(across(c(jurisdiction, health_region, specialty), fct))
  
  readr::write_rds(cihi, "data/cihi.rds")
} else cihi = readr::read_rds("data/cihi.rds")
```

```{r}
g = cihi |>
  filter(
    jurisdiction == 'B.C.',
    health_region == 'B.C.',
    specialty == "All physicians"
) |>
  ggplot(aes(x=year, y=number_of_physicians, color=jurisdiction)) +
  geom_line_interactive() +
  geom_point_interactive(aes(data_id = year, tooltip = "year:" %,,% year %,% "\n# physicians:" %,,% number_of_physicians)) +
  scale_color_viridis_d() + 
  theme(legend.position = 'none') + 
  scale_y_continuous(labels = scales::label_comma()) +
  ggtitle("Physicians in B.C.")

girafe(ggobj = g)

ggsave('images/g1.png')
```



```{r}
good_provinces = c("Canada", "B.C.", "Alta.", "Ont.", "Man.")

cihi |>
  filter(
    specialty == "All physicians",
    #str_detect(jurisdiction, "Canada|\\.$") |>
    health_region %in% good_provinces
  ) |>
  mutate(is_bc = health_region == 'B.C.') |>
  mutate(is_bc_scale = case_when(is_bc ~ 2, T ~ 1)) |>
  ggplot(aes(x=year, y=phys_pop_ratio, color=jurisdiction, size=is_bc_scale, linewidth=is_bc_scale)) +
  geom_line() +
  geom_point() +
  scale_color_viridis_d() + 
  scale_y_continuous(labels = scales::label_comma()) +
  guides(linewidth = 'none', size = 'none') +
  ggtitle("Physicians per Pop - across Canada") +
  theme(legend.position = 'bottom')

ggsave('images/g2.png')
```

```{r}
#| column: page
#| fig-width: 10

g1 = cihi |>
  filter(
    jurisdiction == 'B.C.',
    health_region == 'B.C.',
    specialty == "All physicians"
) |>
  ggplot(aes(x=year, y=median_age)) +
  geom_line() +
  geom_point() +
  scale_color_viridis_d() + 
  theme(legend.position = 'none') + 
  scale_y_continuous(labels = scales::label_comma()) +
  ggtitle("Median Physician Age")


df = cihi |>
  filter(
    jurisdiction == 'B.C.',
    health_region == 'B.C.',
    specialty == "All physicians",
    year %in% c(2015, 2020, 2024)
) |>
  select(year, starts_with("age_group")) |>
  rename("00-30" = age_group_younger_than_30, "80-100" = age_group_80_and_older) |>
  select(-age_group_unknown) |>
  pivot_longer(cols = 2:last_col()) |>
  mutate(name = str_extract(name, "\\d\\d-\\d\\d")) |>
  rename(age_group = name) |>
  mutate(year = fct(as.character(year)))

g2 = df |>
  group_by(year) |>
  summarise(total_pop = sum(value)) |>
  inner_join(df) |>
  mutate(prop_phys = value / total_pop) |>
  ggplot(aes(x=age_group, y=prop_phys, color=year, group=year)) +
  geom_line() +
  geom_point() +
  scale_color_viridis_d() + 
  scale_y_continuous(labels = scales::label_percent()) +
  ggtitle("Relative Age Distribution by Year") +
  theme(legend.position = 'bottom')

g1 + g2

ggsave('images/g3.png')
```



```{r}
cihi |>
  filter(
    jurisdiction == 'B.C.',
    health_region == 'B.C.',
    specialty == "All physicians"
) |>
  select(year, number_of_physicians, number_female, number_male) |>
  mutate(across(3:4, ~./number_of_physicians)) |>
  rename_with(~str_replace_all(., "number", "prop"), 3:4) |>
  select(year, starts_with("prop")) |>
  pivot_longer(2:3) |>
  mutate(name = str_remove(name, "prop_")) |>
  ggplot(aes(x=year, y=value, color=name)) +
  geom_line() +
  geom_point() +
  scale_color_viridis_d() + 
  theme(legend.position = 'bottom') + 
  scale_y_continuous(labels = scales::label_percent()) +
  ggtitle("Gender Distribution") 

ggsave('images/g4.png')
```


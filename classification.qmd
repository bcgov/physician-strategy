---
format:
  revealjs:
    theme: 'style/hsiaR_style2.scss'
    fontfamily: 'BC Sans'
margin: 0
center: false
width: '100%'
height: '100%'
embed-resources: true
editor_options: 
  chunk_output_type: console
execute: 
  echo: true
---

# MSP Classification Plan

Tim

2026-01-07

## Steps

1.  Choose classes
2.  Classify each MSP encounter
3.  Obtain relevant external information on pracs
4.  Classify each prac

# 1. Choose classes

## FITM

```{r}
pacman::p_load(hsiaR, tidyverse)
con = hiConnect()

fitms = hiQuery("select * from ahip.fitmds", print_interpolated_query = F)
nrow(fitms)
```

## FITM

```{r}
fitms |> slice_sample(n=10)
```

## FITM

```{r}
classes = tibble(class = c("mental health", "emergency", "anaesthesia", "pain management", "surgical assist", "advice", "not a visit", "dermatology", "referral", "unknown")) |>
    mutate(class_id = row_number(), .before=1) |> 
    mutate(class_id = case_match(class, "unknown" ~ NA, .default = class_id))

classes
```

## FITM

```{r}
fitm_classes = fitms |>
  mutate(class_id = case_when(
    str_detect(fitmdesc, "(?i)MENTAL|OPIOID|DRUG") ~ 1L,
    str_detect(fitmdesc, "(?i)EMERGENCY") ~ 2L,
    str_detect(fitmdesc, "(?i)(?<!NO )ANA?ESTHESIA|EPIDURAL") ~ 3L,
    str_detect(fitmdesc, "(?i)TRIGGER POINT INJECTION|PERIPHERAL NERVE BLOCK|NEUROTOMY") ~ 4L,
    str_detect(fitmdesc, "(?i)SURGICAL ASSIST") ~ 5L,
    str_detect(fitmdesc, "(?i)ADVICE|CONSULT EXP|CONFERENCE|FP BRIEF CLIN. CONF W/ ALL. CARE PROV. AND/OR PHYS") ~ 6L,
    str_detect(fitmdesc, "(?i)INCENTIVE|PCN PANEL RPT: GENERAL|PRIMARY CARE PANEL REPORT|PCN ATTACH RPT|PCN DETACH RPT|CARE TIME-PER 15 MIN|MANAGEMENT FEE|REGISTRATION CODE|LFP|15 MIN|ENROLMENT CODE") ~ 7L,
    fitm %in% c(98001,98002,98003,98004,98006) ~ 7L,
    str_detect(fitmdesc, "(?i)WARTS|ULTRA VIOLET B TREATMENT|EXCISION TUMOR OF SKIN|EXCISION ADDITIONAL TUMOR OF SKIN") ~ 8L,
    str_detect(fitmdesc, "(?i)REFERRAL|TRAY") ~ 9L,
    T ~ NA
  )) |>
  inner_join(classes) |>
  select(fitm, class_id, class)
```

## FITM

```{r}
fitm_classes |> count(class)
```

## FITM

```{r}
fitm_classes |> na.omit() |> slice_sample(n = 10)
```

## SERVCODE

```{r}
servcds = hiQuery("select * from ahip.servcode", print_interpolated_query = F)
nrow(servcds)
```

## SERVCODE

```{r}
servcds |> slice_sample(n = 10)
```

## Summary

-   FITM, SERVCD, SERVLOC
-   Based on Dr. Sandra Roy's work
-   Incomplete. (mostly "unknown"; what is "not a visit?"; only FPs)
-   Multiple classifications?
-   Would need to be maintained, since FITMs change
-   Table in MSEA

# 2. Classify each MSP encounter

## hiBuildSQL

```{r}
hsiaR::hiBuildSQL$query$msp_encounters()
```

## hiBuildSQL

```{r}
hiBuildSQL$select$msp_encounters = "
  distinct msp.pracnum,
  trunc(servdt) as servdt,
  clnt.mrg_clnt_anon_idnt_id as clnt_label
  fitm.fitm,
  fitm.fitm_class
"
```

## Toy df

```{r}
query = hiBuildSQL$query$msp_encounters(start = "2025-01-01", end = "2025-01-03")

if (fs::file_exists("data/msp_encounters.Rds")) msp_encounters = readRDS("data/msp_encounters.Rds") else msp_encounters = hiQuery(query, print_interpolated_query = F, con = hiConnect()); saveRDS(msp_encounters, "data/msp_encounters.Rds")

msp_encounters = msp_encounters |>
  mutate(servdt = as.Date(servdt)) |>
  mutate(func_spty_cd = as.integer(func_spty_cd))
```

## Toy df

```{r}
msp_encounters |> slice_sample(n=10)
```

# 3. Obtain relevant external information on pracs

## ???

-   I have no idea about this part
-   SCRUBS? Prac roster?

# 4. Classify each prac

## Counts per day

```{r}
msp_encounters |>
  count(pracnum, func_spty_cd, servdt, fitm_class)
```

## Example: 22895

```{r}
msp_encounters |>
  filter(pracnum == 22895) |>
  count(pracnum, func_spty_cd, servdt, fitm_class)
```

## Example: 22895

```{r}
msp_encounters |>
  filter(pracnum == 22895) |>
  count(pracnum, func_spty_cd, servdt, fitm_class) |>
  add_count(pracnum, func_spty_cd, servdt, wt = n, name = "total") |>
  mutate(perc = n / total) |>
  select(pracnum, func_spty_cd, servdt, fitm_class, perc) |>
  pivot_wider(names_from = fitm_class, values_from = perc) |>
  mutate(across(4:last_col(), ~replace_na(., 0)))
```

## Example: 22895

```{r}
msp_encounters |>
  filter(pracnum == 22895) |>
  count(pracnum, func_spty_cd, servdt, fitm_class) |>
  group_by(pracnum, func_spty_cd, fitm_class) |>
  arrange(servdt) |>
  mutate(n = cumsum(n)) |>
  ungroup() |>
  add_count(pracnum, func_spty_cd, servdt, wt = n, name = "total") |>
  mutate(perc = n / total) |>
  select(pracnum, func_spty_cd, servdt, fitm_class, perc) |>
  pivot_wider(names_from = fitm_class, values_from = perc) |>
  mutate(across(4:last_col(), ~replace_na(., 0)))
```

## Summary

-   ML?
-   By day? By month? By year?

## Make the table

```{r}
prac_class = msp_encounters |>
  mutate(fitm_class = str_replace_all(fitm_class, " ", "_")) |>
  count(pracnum, func_spty_cd, servdt, fitm_class) |>
  group_by(pracnum, func_spty_cd, fitm_class) |>
  arrange(servdt) |>
  mutate(n = cumsum(n)) |>
  ungroup() |>
  add_count(pracnum, func_spty_cd, servdt, wt = n, name = "total") |>
  mutate(perc = n / total) |>
  select(pracnum, func_spty_cd, servdt, fitm_class, perc) |>
  arrange(pracnum, func_spty_cd, servdt, desc(perc))
```

## Top class?

```{r}
prac_class |>
  group_by(pracnum, servdt) |>
  slice_head(n = 1)
```

## Top 2 classes?

```{r}
prac_class |>
  group_by(pracnum, servdt) |>
  slice_head(n = 2) |>
  mutate(rank = rank(desc(perc), ties.method = "min")) |>
  group_by(pracnum, servdt, rank) |>
  summarise(fitm_class = paste(fitm_class, collapse = ", "), .groups = "drop") |>
  pivot_wider(names_from = rank, values_from = fitm_class)
```

## Top 5 classes?

```{r}
prac_class |>
  group_by(pracnum, servdt) |>
  slice_head(n = 5) |>
  mutate(rank = rank(desc(perc), ties.method = "min")) |>
  group_by(pracnum, servdt, rank) |>
  summarise(fitm_class = paste(fitm_class, collapse = ", "), .groups = "drop") |>
  pivot_wider(names_from = rank, values_from = fitm_class) |>
  filter(!is.na(`5`))
```
